\section{Módulos}
Para a criação dos módulos de hardware, foram escolhidos componentes de \wiot{} comerciais, que possuem preços acessíveis, ampla documentação disponível e uma comunidade de desenvolvedores crescente.

A interconexão dos componentes, bem como a comunicação com o mundo externo pela internet será intermediada por um servidor local, que rodará na plataforma Raspberry Pi, rodando um sistema operacional Linux (Raspbian, baseado em Debian) e que dispõe da interface de hardware necessária para conexão com a rede.

Os sensores e atuadores devem ser conectados fisicamente com um módulo controlador, de modo que, para contornarmos essa limitação, utilizaremos módulos ESP8266 para transmissão sem fio por meio de Wi-Fi. Esses módulos serão responsáveis pela transmissão das informações recebidas para o servidor local. Toda a arquitetura para essa transmissão será detalhada mais à frente. Os outros módulos a serem utilizados, como sensores DHT11, LM555, etc. podem ser vistos em uma lista completa no Anexo X. % TODO precisa colocar essa lista no anexo e colocar a referência aqui

Em geral, esses módulos consistem do microcontrolador, relés, sensores e fontes/conversores de tensão a depender do módulo, além de um circuito para manutenção corretiva baseado no astável 555, conectados à rede Wi-Fi e/ou trabalhando como pontos de acesso. Para casos de falha de conexão, há um algoritmo de novas tentativas com tempos progressivamente maiores conforme as falhas ocorrerem, que busca deixar o módulo disponível para outras funções enquanto o serviço não está disponível. Para evitar o travamento, um sinal de \textit{keep alive} é monitorado, e um circuito anti-travamento deve ativar um \textit{hard reset} (reset por hardware), ou então uma rotina de \textit{soft reset} deve ser acionada. No entanto, observe que a segunda alternativa é a mais fácil de implementar, mas a menos robusta, já que ainda pode não funcionar em casos de loop infinito.

\subsection{Módulos Base}
\subsubsection{ESP8266}
O ESP8266 é um microprocessador com baixo consumo e conexão Wi-Fi 802.11 integrada \cite{espressif}. Pode ser programado usando a Arduino IDE, já muito utilizada \cite{thomsen}. Opera com uma tensão de 3.3 V, suporta WPA e possui modo de interrupção somente por software. É amplamente usado como \textit{shield} para conexão Wi-Fi de placas de desenvolvimento da plataforma Arduino; contudo, no projeto Hedwig, o utilizaremos em modo \textit{StandAlone} como principal processador e responsável pela conexão dos diferentes módulos de automação. Suas duas principais plataformas de desenvolvimento são Wemos\footnote{https://www.wemos.cc/} e NodeMCU\footnote{http://nodemcu.com/}. O projeto utilizará o Wemos D1 Mini, versão compacta da Wemos D1 R2.

Possui um modo de operação de baixa potência (\textit{sleep mode}) em que o consumo de bateria fica muito menor - em contrapartida, o nível de funcionalidades fica limitado. Podemos usar 7 portas de E/S digitais e uma porta de entrada analógica. Duas portas são inutilizáveis, pois são usadas para programação e outras tarefas do sistema integrado do ESP8266. Alternativas para extensão de portas são: utilizar três níveis de sinal análogico para detectar três tipos de acionamento, através de um circuito dedicado, com priorização de entrada; usar interface I2C, como o usado para o display; ou usar radiofrequência, por meio de um par receptor-transmissor integrado no módulo, controles, atuadores e sensores sem fio.

\subsection{Módulo de Acesso}

Buscando garantir mais segurança e comodidade para o acesso à residência, além do controle de abertura, o módulo de acesso atua em paralelo com uma fechadura eletrônica, que é acionada por meio de controle remoto, que utiliza ondas de rádio. Assim, mesmo com falha total do sistema, o usuário pode abrir o portão diretamente, sem a necessidade de acesso à Internet.

\begin{figure}[H]
	\centering
	\caption{Diagrama ilustrativo do módulo de Acesso ao Portão}
  \includegraphics[width=0.8\textwidth]{diagramaModuloAcesso}
\label{fig:diagramaModuloAcesso}
\end{figure}

O diagrama ilustra, em vermelho, os sistemas já existentes. Sensor e sirene sem fio adicionais são mostrados em verde (dispositivos externos ao módulo, que se comunicam por rádio); o próprio módulo de acesso, com um buzzer embutido, e sua conexão com a rede local Wi-Fi ou sua conexão direta com o celular (quando o módulo opera como um ponto de acesso de rede), em amarelo; além de funcionalidades adicionais, em roxo.

A comodidade, no exemplo em questão, está em abrir o portão por meio do celular, ao utilizar o aplicativo web ou o aplicativo local (de emergência), sem a necessidade de carregar uma chave ou controle.

Entretanto, é necessário que a realização do controle de acesso seja feita de maneira segura. Assim, a funcionalidade é apenas local (o usuário deve estar com o celular conectado à rede da casa para acessar a página local), e um algoritmo de rotação de teclas é utilizado, para evitar que pessoas mal intencionadas possam (1) olhar e copiar a senha que o usuário digita em seu celular e (2) copiar os dados de abertura e usá-los mais tarde (\textit{middle man}). Na última alternativa, a cada acesso de um usuário, um novo mapeamento de teclas é gerado e enviado ao usuário. Mesmo que haja cópia, ela não funcionará devido ao mapeamento ter mudado. Observe ainda que a fechadura eletrônica, por si só, já estava vulnerável a este tipo de ataque - há, inclusive, dispositivos copiadores de senhas.

Outro aspecto de segurança é a preocupação dos usuários em esquecer a porta ou portão abertos. Para mitigar esse perigo, o módulo deve monitorar, por meio de um sensor, o estado vigente (aberto/fechado), e alertar localmente (por meio de \textit{buzzer}) e remotamente (e.g. por email ou notificação no \textit{smartphone}) o usuário. Essa e outras configurações (como de rede) são acessadas por uma senha diferente daquela de abertura, de modo que a interface básica seja simples para uso.

Para o caso de falha de envio de notificação (e.g. servidor fora do ar, ou indisponibilidade na conexão), há um algoritmo de novas tentativas com tempos progressivamente maiores conforme as falhas ocorrerem, buscando deixar o módulo disponível para outras funções. Tratamento análogo é realizado no servidor local, e no sistema de mensageria, de modo a evitar perdas de mensagens, mesmo em situações desfavoráveis. Para o caso de falta de conexão à internet, o módulo não seria controlável pela nuvem, com o aplicativo web, mas sim com o aplicativo emergencial, com a ativação do \textit{Access Point}, desenvolvido para operar diretamente com os módulos, sem intermédio do servidor local e dos serviços remotos.

Por meio dos dados de login dos usuários no sistema, é possível saber qual dos usuários que solicitou a abertura do portão. A persistência destes acessos pode ser analisada, e, utilizando-se técnicas de Machine Learning, perfis de acesso podem ser determinados, e evoluir até o sistema saber quando houver um acesso em horário inesperado e notificar o usuário remotamente. O aprendizado de máquina é fundamental aqui para descobrir comportamentos que podem ser entendidos como suspeitos. Para um usuário que costuma chegar em um horário aproximado todos os dias, e acionar funções semelhantes da casa, uma tentativa de acesso que não se enquadre em tais padrões pode ser produto de atividade criminosa, a qual pode ser informada pela casa para uma central, que acionaria a polícia caso não seja um falso positivo.

\subsection{Módulo de Quarto/Sala/Cozinha}
Um módulo com muitas opções de implantação é o denominado módulo de quarto, pois pode ser usado no controle de iluminação para corredores, salas e ambientes externos.

\begin{figure}[H]
	\centering
	\caption{Diagrama ilustrativo do módulo de Quarto/Sala/Cozinha}
	\includegraphics[width=0.8\textwidth]{diagramaModuloQuarto}
	\label{fig:diagramaModuloQuarto}
\end{figure}

O diagrama ilustra equipamentos externos ao sistema em vermelho (lâmpada e abajur), enquanto o controle e sensor de abertura possuem comunicação sem fio. Em roxo, temos os equipamentos opcionais.

Como principais funcionalidades, temos o despertador (configurado pelo usuário, que também pode receber recomendações baseadas na informação gerada pelo monitoramento de seus ciclos de sono); monitoramento de temperatura e umidade do ambiente (com notificações caso esses par metros indiquem perigo para a saúde); controle de iluminação (da luz direta, que é a lâmpada central do ambiente, com maior potência, e da luz indireta, que é usualmente um abajur ou uma lâmpada com menor potência, usada para leitura); e estado da janela, para verificar remotamente se a janela está fechada ou não (por notificação ou visualização no aplicativo, interessante para dias chuvosos). Além disso, se o módulo for instalado em ambientes internos e externos, o usuário pode usufruir de dados de temperatura e umidade, que podem ser usados para escolha de levar ou não uma blusa/guarda chuva para o trabalho ou se é mais vantajoso deixar roupas secando dentro ou fora de casa, e em que períodos.

O módulo de quarto pode ser acoplado ao sistema existente (fisicamente, é instalado no mesmo lugar do interruptor), e possui alguns estados para o despertador. No estado inicial, somente a luz indireta é ligada. Após determinado tempo (programável pelo usuário), temos avisos sonoros periódicos. No terceiro estado, os períodos são menores. Finalmente, no quarto estado a luz direta é ligada e os avisos sonoros são ininterruptos. Até o terceiro estado, o alarme pode ser desarmado (apertar duas vezes) ou entrar em estado soneca (apertar única vez) diretamente no módulo. Já no estado 4, a critério anterior do usuário, o alarme pode ser desarmado somente fisicamente em outro módulo presente em outro aposento (por exemplo, na sala). Esse módulo pode variar de dia para dia, caso o usuário assim desejar. O sistema desarma o alarme após 40 minutos.

O display possui iluminação automática para não aparentar brilho muito intenso quando todas as luzes estiverem desligadas (por meio de circuito baseado em LDR). Para o controle da iluminação, há diferentes tempos para desligamento. Por exemplo, quando ocorre controle manual (pelo botão presente no módulo), o tempo pode ser maior, por exemplo, de 10 minutos. Já pelo modo automático, quando a luz já foi ligada pelo próprio módulo, o tempo para desligamento pode ser menor (por exemplo, 4 minutos). Com o monitoramento da presença, temos um “preset” da contagem para desligamento sempre que houver presença detectada, de forma a inibirmos acionamentos desnecessários do relé. Outra aplicação para o monitoramento da presença é a descoberta de comportamento anormal. Por exemplo, se o usuário sempre toma café entre 8 e 10 horas, e não apresentar presença na casa até as 15 horas, o sistema pode notificar emails de parentes cadastrados.

\subsection{Módulo de Aquário}

Devido a altos custos de compra, implantação e manutenção de um aquário, que pode ser plantado, de água doce ou salgada, e até abrigar espécies raras, é desejável que uma série de riscos sejam mitigados. Além disso, também podemos ter um valor sentimental agregado.
Dentre tais riscos, destacam-se:

\begin{table}[hbp]
	\centering
	\caption{Riscos para o Aquário}
	\resizebox{\textwidth}{!}{%
		\begin{tabular}{clp{8cm}p{8cm}}
			\toprule
			\textbf{Perigo/Necessidade} 		& \textbf{Origem} 					& \textbf{Consequência} 			 	
			\\
			\midrule
			1. Aquecimento acidental 									&
			Ajuste errado da temperatura do termostato				& Superaquecimento; risco de mortes (peixes e plantas)													\\
			2. Falta de água 									&
			Vazamento ou evaporação natural				& Mal funcionamento ou queima da bomba submersa (à longo prazo, falta de oxigenação da água)													\\
			3. Falta de circulação de água 									&
			Entupimento do tubo de circulação ou mal funcionamento da bomba				& Falta de oxigenação da água, ocasionando em risco de mortes (peixes)													\\
			4. Iluminação adequada									&
			Existência de plantas e/ou iluminação natural insuficiente no ambiente do aquário				& Ambiente nocivo para os peixes, risco de morte das plantas (principalmente durante períodos de esquecimento/viagens)							
			\\
			\bottomrule
	\end{tabular}}
	\label{table:riscosaquario}
\end{table}

Sobre o caso específico da residência onde foram executados os testes de campo, considere um aquário com 50 litros de água, com uma bomba reserva (não a responsável pela circulação de água, que não muda o volume interno) e um aquecedor, com muitos peixes dentro, que são sensíveis à variação brusca de temperatura.

\begin{figure}[H]
	\centering
	\caption{Aquário de Santo André}
	\includegraphics[width=0.8\textwidth]{aquario}
	\label{fig:aquario}
\end{figure}

Na ocasião de troca de água do aquário, cerca de 20\% do volume de água é trocado. A saída de água se dá por um funil (simplificamos para uma vazão de saída constante), e a adição é realizada pela bomba auxiliar, que possui água limpa, sem cloro e com certeza menos amônia e outros compostos nocivos aos peixes (que justificam essa troca periódica de água). O monitoramento do nível da água pode também mitigar o risco de esquecimento (o que levaria o nível da água a tender a zero).

\begin{figure}[H]
	\centering
	\caption{Diagrama ilustrativo do módulo de Aquário}
	\includegraphics[width=0.8\textwidth]{diagramaAquario}
	\label{fig:diagramaAquario}
\end{figure}

Para mitigar os riscos descritos anteriormente, foi desenvolvido o módulo de aquário, que permite:

\begin{enumerate}
	\item Controle de horários em que a lâmpada fica acesa, fornecendo uma iluminação adequada para as plantas e peixes do aquário em períodos curtos de viagem;
	\item Monitoramento do nível de água do aquário principal, alerta pelo aplicativo quando não estiver no nível esperado (pode ocorrer por muita evaporação, vazamento ou problema com a bomba);
	\item Monitoramento da Temperatura do Aquário, e bloqueamento do aquecedor caso a água já esteja numa temperatura desejável (evitar superaquecimento devido a mal funcionamento do termostato), feito por meio de ligação em série com o termostato do aquário;
	\item Nos casos de perigo acima descritos, alerta sonoro também localmente (por meio do buzzer).
	
\end{enumerate}

\subsection{Módulo de Interface com Sistema de Alarmes}

\begin{figure}[H]
	\centering
	\caption{Diagrama ilustrativo do módulo de Interface com Sistema de Alarmes}
	\includegraphics[width=0.8\textwidth]{diagramaAlarme}
	\label{fig:diagramaAlarme}
\end{figure}


O módulo de interface com o sistema de alarmes monitora dois setores específicos, um relativo a presença, que possui sensores no corredor e na sala da residência, e outro relativo a porta da sala (sensor único na porta da residência). Foi instalado numa residência em Jarinu (SP).

Um problema recorrente é o estado da internet, que apesar de indicar conexão, não fornecia acesso a sites tampouco acesso externo por meio de abertura de porta do roteador. Para contornar isso e deixar o módulo disponível para que um outro módulo coletasse seus dados e os persistisse em cartão SD, foi instalado também um rele NF (normalmente fechado) em série com a alimentação do roteador. Em caso do módulo estar desligado, o roteador fica ligado.

Já quando há erro persistente (maior que 10 vezes com intervalos de 2 a 3 minutos) de erro de ping com sites ou servidores conhecidos, o módulo reinicia a conexão, atuando diretamente no roteador. Ocorre a execução deste procedimento em intervalos cada vez mais espaçados, de forma a não executar muitas vezes o reinício do roteador sem que a conexão seja reestabelecida com sucesso (nas primeiras tentativas, temos um intervalo de 3 minutos até a nova tentativa, a partir da terceira vez um intervalo de 10 minutos, e assim por diante).

Outra dificuldade encontrada em sua instalação em campo foi o fato de obtenção de endereço IP muito baixo (onde outros dispositivos, tais como celulares e tablets também obtinham endereços), gerando alguma interferência e indisponibilidades do módulo. Com a mudança do endereço IP para fixo, em outro intervalo de endereçamento, o módulo passou a ter alta disponibilidade, ficando até semanas sem reiniciar.
